{% extends 'core/base.html' %}
{% load static %}

{% block base_title %}Schedule{% endblock %}
{% block base_subhead_heading %} Schedule {% endblock %}


{% block base_css %}

    <style>
        .md-meal-type {
            font-size: 14px;
            font-weight: 600;
            opacity: .6;
        }

        .md-meal-planner-popup .mbsc-popup .mbsc-popup-header {
            padding-top: 8px;
            padding-bottom: 8px;
        }

        .md-meal-planner-cont {
            position: relative;
            padding-left: 34px;
            text-align: left;
        }

        .md-meal-planner-title {
            font-size: 20px;
        }

        .md-meal-planner-kcal {
            color: #929292;
        }

        .md-meal-planner-icon {
            position: absolute;
            left: 0;
        }

        .md-meal-planner-calendar.mbsc-calendar .mbsc-schedule-event-all-day-inner {
            height: 40px;
            display: flex;
            align-items: center;
        }

        .md-meal-planner-calendar .md-meal-planner-event-title {
            font-size: 12px;
        }

        .md-meal-planner-calendar .md-meal-planner-event-desc {
            opacity: .6;
        }

        .md-meal-planner-popup .mbsc-segmented-item:first-child .mbsc-selected.mbsc-material,
        .md-meal-planner-popup .mbsc-segmented-item:first-child .mbsc-selected.mbsc-windows,
        .md-meal-planner-popup .mbsc-segmented-item:first-child .mbsc-segmented-selectbox-inner {
            background: #f08786;
        }

        .md-meal-planner-popup .mbsc-segmented-item:nth-child(2) .mbsc-selected.mbsc-material,
        .md-meal-planner-popup .mbsc-segmented-item:nth-child(2) .mbsc-selected.mbsc-windows,
        .md-meal-planner-popup .mbsc-segmented-item:nth-child(2) .mbsc-segmented-selectbox-inner {
            background: #8abe89;
        }

        .md-meal-planner-popup .mbsc-segmented-item:nth-child(3) .mbsc-selected.mbsc-material,
        .md-meal-planner-popup .mbsc-segmented-item:nth-child(3) .mbsc-selected.mbsc-windows,
        .md-meal-planner-popup .mbsc-segmented-item:nth-child(3) .mbsc-segmented-selectbox-inner {
            background: #99d3ef;
        }

        .md-meal-planner-popup .mbsc-segmented-item:nth-child(4) .mbsc-selected.mbsc-material,
        .md-meal-planner-popup .mbsc-segmented-item:nth-child(4) .mbsc-selected.mbsc-windows,
        .md-meal-planner-popup .mbsc-segmented-item:nth-child(4) .mbsc-segmented-selectbox-inner {
            background: #f0ce8e;
        }

        .md-meal-planner-popup .mbsc-segmented-item:last-child .mbsc-selected.mbsc-material,
        .md-meal-planner-popup .mbsc-segmented-item:last-child .mbsc-selected.mbsc-windows,
        .md-meal-planner-popup .mbsc-segmented-item:last-child .mbsc-segmented-selectbox-inner {
            background: #b48bce;
        }

        .md-tooltip .mbsc-popup-content {
            padding: 0;
        }

        .md-tooltip {
            font-size: 15px;
            font-weight: 600;
        }

        .md-tooltip-header {
            padding: 12px 16px;
            color: #eee;
        }

        .md-tooltip-info {
            padding: 16px 16px 60px 16px;
            position: relative;
            line-height: 32px;
        }

        .md-tooltip-time,
        .md-tooltip-status-button {
            float: right;
        }

        .md-tooltip-title {
            margin-bottom: 0px;
        }

        .md-tooltip-text {
            font-weight: 200;
        }

        .md-tooltip-info .mbsc-button {
            font-size: 14px;
            margin: 0;
        }

        .md-tooltip-info .mbsc-button.mbsc-material {
            font-size: 12px;
        }

        .md-tooltip-view-button {
            position: absolute;
        }

        .md-tooltip-delete-button {
            position: absolute;
            bottom: 16px;
            right: 16px;
        }
    </style>
    <link href="{% static 'mobi/css/mobiscroll.jquery.min.css' %}" rel="stylesheet"/>
{% endblock %}


{% block base_content %}

    {# TODO: UPDATE #}
    {# 1. right click to open menu #}
    {# 1. rc oprions [shift pattern, single shift] #}
    {# 1. shift pattern: full details shift #}
    {# 1. shift single : no pattern or detailed down #}
    {# 1. stciky header of first option  #}

    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="card-title">
                        <div class="d-flex justify-content-between">
                            <h3></h3>
                            {% csrf_token %}
                            <span>
                                    <a href="{% url 'admins:shift-add' %}" class="btn btn-primary">
                                        Create Shift
                                    </a>
                                </span>
                        </div>
                    </div>
                    <div id="news-feed-index-table" data-livecount="0">
                        <form action="" method="GET" class="row m-0 mb-2">
                            <div class="col-12 m-0 p-0">
                                <div class="row m-0 p-0">
                                    <div class="col-sm-12 mb-md-0 p-0">
                                        <div class="form-group m-0 px-2 py-1 border rounded">
                                            <i class="fa fa-search mr-2"></i>
                                            <input class="border-0 bg-transparent w-75" type="text" name="search"
                                                   placeholder="Search employee" value=""
                                            >
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </form>
                        <p class="text-muted mb-2"><small>Last updated: 00:00:00 00/00/0000&nbsp;&nbsp;<a href="#">(paused)</a>&nbsp;&nbsp;</small>
                        </p>
                        <hr>

                        <div id="demo-meal-planner" class="md-meal-planner-calendar"></div>

                        {# SHIFT DETAIL MODEL DESIGN START #}
                        <div id="custom-event-tooltip-popup" class="md-tooltip">
                            <div id="tooltip-event-header" class="md-tooltip-header">
                                <span id="tooltip-event-name-age" class="md-tooltip-name-age"></span>
                                <span id="tooltip-event-time" class="md-tooltip-time"></span>
                            </div>
                            <div class="md-tooltip-info p-4">
                                <div class="row text-center">

                                    <div class="col">
                                        <h3 class="mb-0">
                                            <i class="fa fa-check-double"></i>
                                        </h3>
                                        <p class="mb-0"><b>Shift ID</b></p>
                                        <p class="mb-0 text-muted" id="tooltip-event-title">256154</p>
                                    </div>
                                    <div class="col">
                                        <h3 class="mb-0">
                                            <i class="fa fa-user-cog"></i>
                                        </h3>
                                        <p class="mb-0"><b>Employee</b></p>
                                        <p class="mb-0 text-muted" id="tooltip-event-reason">Ikram Khan</p>
                                    </div>

                                    <div class="col">
                                        <h3 class="mb-0">
                                            <i class="fa fa-campground"></i>
                                        </h3>
                                        <p class="mb-0"><b>Client</b></p>
                                        <p class="mb-0 text-muted" id="tooltip-event-location">Pepsi Co</p>
                                    </div>
                                </div>
                                <button id="tooltip-event-view" mbsc-button data-color="success"
                                        class="btn btn-block">Update Shift
                                </button>
                            </div>
                        </div>

                        <div class="modal fade" id="mark_custom-event-tooltip-popup" tabindex="-1" role="dialog"
                             aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
                            <div class="modal-dialog modal-dialog-centered" role="document">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="exampleModalLongTitle">Modal title</h5>
                                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                            <span aria-hidden="true">&times;</span>
                                        </button>
                                    </div>
                                    <div class="modal-body">
                                        ...
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close
                                        </button>
                                        <button type="button" class="btn btn-primary">Save changes</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="demo-custom-event-tooltip"></div>
                        {# SHIFT DETAIL MODEL DESIGN END #}

                    </div>
                </div>
            </div>
        </div>
    </div>

{% endblock %}

{% block base_internal_scripts %}
    <script src='https://cdn.jsdelivr.net/npm/jquery@3.5.0/dist/jquery.min.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/moment@2.24.0/min/moment.min.js'></script>
    <script src="{% static 'mobi/js/mobiscroll.jquery.min.js' %}"></script>
{% endblock %}

{% block base_external_scripts %}
    <script>

        mobiscroll.setOptions({
            theme: 'ios',
            themeVariant: 'light'
        });

        $(function () {
            var formatDate = mobiscroll.util.datetime.formatDate;
            var calendar;
            var popup;
            var oldMeal;
            var tempMeal;
            var deleteMeal;

            // DATA OBJECTS
            var types = [
                {
                    id: '0',
                    name: 'Not assigned',
                    color: 'red',
                    title: 'Shifts are not assigned',
                    icon: '🍜'
                }
            ]
            {% for object in employees %}
                types.push({
                    id: '{{ object.id }}',
                    name: '{{ object }}',
                    color: 'green',
                    title: 'Employee',
                    icon: '🥨'

                });
            {% endfor %}

            var currentEvent;
            var timer;
            var $tooltip = $('#custom-event-tooltip-popup');
            var $mark_tooltip = $('#mark_custom-event-tooltip-popup');
            {#var $deleteButton = $('#tooltip-event-delete');#}
            var $fileButton = $('#tooltip-event-view');
            var $statusButton = $('#tooltip-event-status');
            var $header = $('#tooltip-event-header');
            var $data = $('#tooltip-event-name-age');
            var $time = $('#tooltip-event-time');
            var $status = $('#tooltip-event-title');
            var $reason = $('#tooltip-event-reason');
            var $location = $('#tooltip-event-location');

            var calendar = $('#demo-meal-planner').mobiscroll().eventcalendar({
                view: {
                    timeline: {
                        type: 'week',
                        eventList: true,
                        startDay: 1,
                        endDay: 0
                    }
                },
                resources: types,
                dragToCreate: false,
                dragToResize: false,
                dragToMove: true,
                clickToCreate: true,
                extendDefaultEvent: function (ev) {
                    return {
                        title: 'New meal',
                        allDay: true
                    };
                },
                onEventCreate: function (args, inst) {
                    // store temporary event

                },
                renderResource: function (resource) {
                    return '<div class="md-meal-planner-cont">' +
                        '<div class="md-meal-planner-title" style="color:' + resource.color + '">' +
                        '<span class="md-meal-planner-icon">' + resource.icon + '</span>' + resource.name + '</div>' +
                        '</div>';
                },
                renderScheduleEventContent: function (args) {
                    var event = args.original;
                    console.log(typeof event.start)
                    return '<div class="md-meal-planner-event">' +
                        '<div class="md-meal-planner-event-title">' + event.title + '</div>' +
                        '<div class="md-meal-planner-event-desc">' + event.start.toString().split("T")[1] + "-" + event.end.toString().split("T")[1] + '</div>' +
                        '</div>';
                },
                showEventTooltip: false,
                onEventHoverIn: function (args, inst) {
                    var event = args.event;
                    var resource = types.find(function (dr) {
                        return dr.id == event.resource
                    });
                    var time = formatDate('hh:mm A', new Date(event.start)) + ' - ' + formatDate('hh:mm A', new Date(event.end));
                    var button = {};

                    currentEvent = event;

                    if (event.confirmed) {
                        button.text = 'Cancel appointment';
                        button.type = 'warning';
                    } else {
                        button.text = 'Confirm appointment';
                        button.type = 'success';
                    }

                    $header.css('background-color', resource.color);
                    $data.text(event.title);
                    $time.text(time);

                    $status.text(event.id)
                    $reason.text(event.employee);
                    $location.text(event.client);

                    $statusButton.text(button.text);
                    $statusButton.mobiscroll('setOptions', {color: button.type});

                    clearTimeout(timer);
                    timer = null;

                    tooltip.setOptions({anchor: args.domEvent.target});
                    tooltip.open();
                },
                onEventHoverOut: function (args) {
                    if (!timer) {
                        timer = setTimeout(function () {
                            tooltip.close();
                        }, 200);
                    }
                },
                onEventClick: function (event, inst) {
                    $mark_tooltip.open();
                },
                onPageLoading: function (event, inst) {

                    $.getJSON('{% url 'admins:admins-api:shift-list' %}', function (data) {
                        var events = [];

                        console.log(data)

                        for (var i = 0; i < data.length; i++) {
                            var event = data[i];

                            events.push({
                                id: event.shift.id,
                                client: event.shift.client.name,
                                employee: event.shift.employee.user.username,
                                title: event.shift.site.name,
                                start: event.shift_date + "T" + event.shift.start_time,
                                end: event.shift_date + "T" + event.shift.end_time,
                                resource: event.shift.employee == null ? 0 : event.shift.employee.id
                            });
                        }

                        inst.setEvents(events);
                        mobiscroll.toast({
                            message: 'shifts are updated'
                        });
                    }, 'jsonp');
                }
            }).mobiscroll('getInst');

            var tooltip = $tooltip.mobiscroll().popup({
                display: 'anchored',
                touchUi: false,
                showOverlay: false,
                contentPadding: false,
                closeOnOverlayClick: false,
                width: 350
            }).mobiscroll('getInst');

            $tooltip.mouseenter(function (ev) {
                if (timer) {
                    clearTimeout(timer);
                    timer = null;
                }
            });

            $tooltip.mouseleave(function (ev) {
                timer = setTimeout(function () {
                    tooltip.close();
                }, 200);
            });

            $statusButton.on('click', function (ev) {
                tooltip.close();
                currentEvent.confirmed = !currentEvent.confirmed;
                calendar.updateEvent(currentEvent);

                mobiscroll.toast({
                    message: 'Appointment ' + (currentEvent.confirmed ? 'confirmed' : 'canceled')
                });
            });

            $fileButton.on('click', function (ev) {
                tooltip.close();

                window.location = "/a/shift/" + currentEvent.id + "/"
            });


        });


    </script>
{% endblock %}