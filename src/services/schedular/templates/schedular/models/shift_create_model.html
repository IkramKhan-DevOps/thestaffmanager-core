{% load static %}
{% load crispy_forms_tags %}
{% load widget_tweaks %}

<div class="modal modal-lg" id="event-create-model">
    <div class="modal-dialog">
        <div class="modal-content">

            <!-- Modal Body -->
            <div class="modal-body">

                <div class="col-sm-12 text-center">
                    <div class="text-center">
                        <iframe src="https://embed.lottiefiles.com/animation/7448"
                                height="200" class="border-0">
                        </iframe>
                    </div>
                </div>
                <form method="post" id="event-create-form">
                    {% csrf_token %}

                    <div class="row">
                        <div class="col-sm-12">
                            <div class="card">
                                <div class="card-body">
                                    <div class="row row-cards">
                                        {% crispy form %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-sm-12">
                        <div id="div_policies" class="card">
                            <div class="card-body">
                                <p class="mb-0 card-title">Repeat Policy</p>
                            </div>
                            <div class="card-body" id="customize">
                                <div>
                                    <div id="weekly">
                                        <p class="mb-2 h3">Weekly Repeat</p>
                                        <div class="form-group row">
                                            <div class="col-md-9">
                                                <div class="checkbox my-2">
                                                    <div class="custom-control custom-checkbox">
                                                        <input type="checkbox" class="custom-control-input"
                                                               id="monday" name="monday"
                                                               data-parsley-multiple="groups"
                                                               data-parsley-mincheck="2"
                                                               {% if object %}{{ monday }}{% else %}checked{% endif %}>
                                                        <label class="custom-control-label" for="monday">
                                                            Monday
                                                        </label>
                                                    </div>
                                                    <div class="custom-control custom-checkbox">
                                                        <input type="checkbox" class="custom-control-input"
                                                               id="tuesday" name="tuesday"
                                                               data-parsley-multiple="groups"
                                                               data-parsley-mincheck="2"
                                                               {% if object %}{{ tuesday }}{% else %}checked{% endif %}>
                                                        <label class="custom-control-label" for="tuesday">
                                                            Tuesday
                                                        </label>
                                                    </div>
                                                    <div class="custom-control custom-checkbox">
                                                        <input type="checkbox" class="custom-control-input"
                                                               id="wednesday" name="wednesday"
                                                               data-parsley-multiple="groups"
                                                               data-parsley-mincheck="2"
                                                               {% if object %}{{ wednesday }}{% else %}checked{% endif %}>
                                                        <label class="custom-control-label" for="wednesday">
                                                            Wednesday
                                                        </label>
                                                    </div>
                                                    <div class="custom-control custom-checkbox">
                                                        <input type="checkbox" class="custom-control-input"
                                                               id="thursday" name="thursday"
                                                               data-parsley-multiple="groups"
                                                               data-parsley-mincheck="2"
                                                               {% if object %}{{ thursday }}{% else %}checked{% endif %}>
                                                        <label class="custom-control-label" for="thursday">
                                                            Thursday
                                                        </label>
                                                    </div>
                                                    <div class="custom-control custom-checkbox">
                                                        <input type="checkbox" class="custom-control-input"
                                                               id="friday" name="friday"
                                                               data-parsley-multiple="groups"
                                                               data-parsley-mincheck="2"
                                                               {% if object %}{{ friday }}{% else %}checked{% endif %}>
                                                        <label class="custom-control-label" for="friday">
                                                            Friday
                                                        </label>
                                                    </div>
                                                    <div class="custom-control custom-checkbox">
                                                        <input type="checkbox" class="custom-control-input"
                                                               id="saturday" name="saturday"
                                                               data-parsley-multiple="groups"
                                                               data-parsley-mincheck="2"
                                                                {% if object %}{{ saturday }}{% else %}{% endif %}>
                                                        <label class="custom-control-label" for="saturday">
                                                            Saturday
                                                        </label>
                                                    </div>
                                                    <div class="custom-control custom-checkbox">
                                                        <input type="checkbox" class="custom-control-input"
                                                               id="sunday" name="sunday"
                                                               data-parsley-multiple="groups"
                                                               data-parsley-mincheck="2"
                                                                {% if object %}{{ sunday }}{% else %}{% endif %}>
                                                        <label class="custom-control-label" for="sunday">
                                                            Sunday
                                                        </label>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div id="selected_dates">
                                        <p class="mb-2 h3">Selected Dates</p>
                                        <form method="POST" class="form-horizontal well" role="form">
                                            <fieldset>
                                                <div class="repeater-custom-show-hide">
                                                    <div data-repeater-list="car">

                                                        {% if shift.repeat_policy == 'd' %}
                                                            {% for shift_day in shift.shiftday_set.all %}

                                                                <div data-repeater-item="" class="mb-2">
                                                                    <div class="form-group row d-flex align-items-end">
                                                                        <div class="col-sm-8">
                                                                            <input id="selected-date-item"
                                                                                   type="date"
                                                                                   name="car[{{ forloop.counter }}][date]"
                                                                                   class="form-control"
                                                                                   value="{{ shift_day.shift_date.isoformat }}">
                                                                        </div>
                                                                        <div class="col-sm-4">
                                                            <span data-repeater-delete="" class="btn btn-danger">
                                                                Remove
                                                            </span>
                                                                        </div>
                                                                    </div>
                                                                </div>

                                                            {% endfor %}
                                                        {% else %}
                                                            <div data-repeater-item="" class="mb-2">
                                                                <div class="form-group row d-flex align-items-end">
                                                                    <div class="col-sm-8">
                                                                        <input id="selected-date-item" type="date"
                                                                               name="car[0][date]"
                                                                               class="form-control">
                                                                    </div>
                                                                    <div class="col-sm-4">
                                                            <span data-repeater-delete="" class="btn btn-danger">
                                                                <i class="fa fa-trash"></i>
                                                            </span>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        {% endif %}

                                                    </div>
                                                    <div class="form-group row mb-0">
                                                        <div class="col-sm-12">
                                                    <span data-repeater-create="" class="btn btn-light btn-md">
                                                        <span class="fa fa-plus"></span> Add Date
                                                    </span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </fieldset>
                                        </form>
                                    </div>

                                    <div id="regular">
                                        <p class="text-danger">Your selected repeat policy is <b>Regular</b>, in
                                            regular
                                            repeat
                                            policy all dates are selected from start to end of this shift</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-2">
                        <button data-action="{% url 'schedular:model_shift_add' %}" data-method="POST"
                                type="submit" id="event-create-btn" class="btn btn-primary">
                            <i class="fa fa-check-circle"></i> Submit
                        </button>
                    </div>

                </form>
            </div>

        </div>
    </div>
</div>


<script>
    $(document).ready(function () {

        let policies_div = $("body #div_policies");
        let repeat_policy_div = $("body #div_id_repeat_policy");
        let end_date_div = $("body #div_id_end_date");
        let end_date_field = $("body #id_end_date");

        let weekly_div = $("body #weekly");
        let regular_div = $("body #regular");
        let dates_div = $("body #selected_dates");
        let client_options = $('body #id_client')
        let site_options = $('body #id_site')

        const empty_html = "<option value>--------</option>"

        let repeat_policy = "{{ object.repeat_policy }}";
        let job_type = "{{ object.job_type }}";

        show_open_form();

        $('body').on('change', '#id_repeat_policy', function () {
            repeat_policy = $(this).val();
            from_the_ashes_we_will_rise();
        });

        $('body').on('change', '#id_job_type', function () {
            job_type = $(this).val();
            from_the_ashes_we_will_rise();
        });

        client_options.change(function (event) {
            site_options.html('')
            let format_html = empty_html;
            let value = $(this).val();
            if (value !== undefined && value != null && value > 0) {
                $.get('/a/api/client/' + value + '/sites/', function (data, status) {
                    if (status === 'success') {
                        for (const datum of data) {
                            format_html += `<option value='${datum.id}'>${datum.name}</option>`;
                        }
                    }
                    site_options.append(format_html);
                });
            }
        });

        function from_the_ashes_we_will_rise(){
            switch(job_type){
                case 'o':
                    show_open_form();
                    break;

                default:
                    show_pattern_form();
            }
        }

        function update_ui(action) {
            switch (action) {
                case 'w':
                    weekly_div.show();
                    dates_div.hide();
                    regular_div.hide();
                    break;

                case 'd':
                    weekly_div.hide();
                    dates_div.show();
                    regular_div.hide();
                    break;

                case 'r':
                    weekly_div.hide();
                    dates_div.hide();
                    regular_div.show();
                    break;

                default:
                    weekly_div.hide();
                    dates_div.hide();
            }

        }

        function show_open_form() {
            repeat_policy_div.hide();
            policies_div.hide();
            end_date_div.hide();
            $("body #div_id_repeat_policy").hide();
            $("body #div_id_end_date").hide();
        }

        function show_pattern_form() {
            repeat_policy_div.show();
            policies_div.show();
            $("body #div_id_repeat_policy").show();
            $("body #div_id_end_date").show();
            update_ui(repeat_policy);
        }

        let event_create_model = $('body #event-create-model');
        let event_create_form = $('body #event-create-form');
        let event_create_btn = $('body #event-create-btn');


        event_create_btn.click(function () {

            $.ajax({
                url: $(this).data('action'),
                type: $(this).data('method'),
                data: new FormData(document.getElementById('event-create-form')),
                cache: false,
                contentType: false,
                processData: false,
                success: function (data) {
                    if (!(data['success'])) {
                        event_create_form.html(data['form_html']);
                        job_type = $('body #id_job_type').val();
                        from_the_ashes_we_will_rise();
                    } else {
                        location.reload();
                    }
                },
                error: function () {
                    event_create_form.find('.error-message').show()
                }
            });

        });
    });


</script>